<!doctype html><html><head><title>Triggers para que vos quero...</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><link rel=icon type=image/png href=/images/favicon_hu8376fd15465fef26ffe66b6bcf0ca686_13669_42x0_resize_box_2.png><link rel=stylesheet href=/css/style.css><meta name=description content="Triggers para que vos quero..."><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/pt><img src=/images/main-logo_hu864bbe108f1be1ae04b57f7f2fd9d631_5637_42x0_resize_box_2.png alt=Logo>Alexandre Neto</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div><img src=/images/main-logo_hu864bbe108f1be1ae04b57f7f2fd9d631_5637_42x0_resize_box_2.png class=d-none id=main-logo alt=Logo>
<img src=/images/inverted-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_42x0_resize_box_2.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=https://srnetochan.github.io/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/pt/posts data-filter=all>Posts</a></li><div class=subtree><li><i class="fas fa-plus-circle"></i><a href=/pt/posts/opinion/>Artigos de Opinião</a><ul><li><a href=/pt/posts/opinion/2013-03-26-nota-de-abertura/>Nota de abertura</a></li><li><a href=/pt/posts/opinion/2013-03-31-porque-o-open-source/>Porquê o Open Source?</a></li><li><a href=/pt/posts/opinion/2013-04-04-as-queixas-do-costume/>As queixas do costume</a></li></ul></li><li><a href=/pt/posts/news/>Notícias</a></li><li><a href=/pt/posts/tutorials/>Tutoriais</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://srnetochan.github.io/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/aneto2.jpg alt="Author Image"><h5 class=author-name>Alexandre Neto</h5><p>December 3, 2013</p></div><div class=title><h1>Triggers para que vos quero...</h1></div><div class=post-content id=post-content><p>Há já algum tempo que queria estudar a funcionalidade de triggers em <a href=http://www.postgresql.org/>PostgreSQL</a>. A grosso modo, tinha ideia que permitiam executar comandos de forma automática, sempre que se alterasse determinada tabela, mas desconhecia os mecanismos para o fazer. Uma das aplicações que me veio à ideia foi a de usar triggers para manter actualizado atributos geométricos como a área ou o comprimento. Quando editamos de elementos que contêm atributos relacionados com as dimensões, forma ou localização das suas geometrias (área, perímetro, comprimento), é muito fácil esquecermo-nos de os actualizar depois da edição. Se mais tarde usarmos esses atributos para realizar alguma análise, este esquecimento pode levar a resultados errados.Como exemplo, vou criar um trigger para actualizar os atributos &ldquo;área&rdquo;, &ldquo;latitude&rdquo; e &ldquo;longitude&rdquo; de uma tabela de polígonos.A primeira coisa a fazer é criar uma função que execute o que pretendemos. No caso em questão, usei a seguinte:</p><pre><code>[code language=&quot;sql&quot;]
CREATE OR REPLACE FUNCTION update_geometry_fields()
RETURNS trigger;
$BODY$
DECLARE
lat_long TEXT;
BEGIN
-- Cálculo da área da geometria
NEW.area = st_area(NEW.geom);

-- Cálculo da latitude e longitude do centroíde da geometria em graus minutos e segundos
lat_long := ST_AsLatLonText(st_transform(st_centroid(NEW.geom), 4326));
NEW.latitude = split_part(lat_long,' ',1);
NEW.longitude = split_part(lat_long,' ',2);

RETURN NEW;
END;
$BODY$
LANGUAGE plpgsql VOLATILE
[/code]
</code></pre><p>Depois, é necessário criar o trigger que despolete a função:</p><pre><code>[code language=&quot;sql&quot;]
CREATE TRIGGER update_epvu_sgev_geom_fields
BEFORE INSERT OR UPDATE OF geom
ON epvu.sgev
FOR EACH ROW
EXECUTE PROCEDURE update_geometry_fields();
[/code]
</code></pre><p>O trigger, quando lido em inglês, é bastante simples de entender. Antes de inserir uma linha nova, ou actualizar a geometria (geom) de uma linha existente da tabela &ldquo;epvu.sgev&rdquo;, executa a função update_geometry_fields() De notar que a criação do triggers (e respectivas funções) pode ter variações. Em primeiro lugar, os triggers podem ser despoletados antes ou depois de um INSERT, DELETE ou UPDATE numa tabela. Em segundo, podem executar a função sobre toda a tabela ou apenas nas linhas em questão. Para ilustrar estas diferenças, mais um exemplo. Com o objectivo de optimizar a impressão em mapas no <a href=www.qgis.org>QGIS</a>, através da nova funcionalidade de <a href=http://docs.qgis.org/testing/en/docs/user_manual/print_composer/print_composer.html#atlas-generation>atlas</a> do print composer, criei uma consulta para agregar vários polígonos com base num atributo (&ldquo;codigo&rdquo;) e me determinasse se os multi-polígonos resultantes encaixava melhor numa folha ao alto ou deitado. Na tentativa de tornar o processo mais rápido, pensei em gravar a consulta como tabela mantê-la actualizada sempre que alguma alteração pertinente ocorresse através de um trigger. A função a usar no trigger era pouco mais que a consulta em si:</p><pre><code>[code language=&quot;sql&quot;]
CREATE OR REPLACE FUNCTION epvu.refresh_geom_paginas_prestadores()
RETURNS trigger AS
$BODY$
BEGIN
TRUNCATE epvu.geom_paginas_prestadores restart identity;
INSERT INTO epvu.geom_paginas_prestadores (codigo, formato, geom)
(WITH g as
(SELECT (st_union(st_makevalid(geom))) AS geom,
    codigo
 FROM
    epvu.sgev
 GROUP BY codigo
)
SELECT
    g.codigo,
    CASE WHEN abs(ST_XMax(g.geom)-ST_XMin(g.geom)) &gt; abs(ST_YMax(g.geom)-ST_YMin(g.geom)) THEN
        'Landscape'
    ELSE
        'Portrait'
    END as formato,
    st_multi(g.geom) as geom
FROM g);
RETURN NEW;
END;
$BODY$
LANGUAGE plpgsql VOLATILE
[/code]
</code></pre><p>Neste caso, a função deve ser despoletada sempre que forem feitas alterações à tabela que usada na consulta (epvu.sgev) e que possam alterar os seus resultados. Assim, sempre que haja introdução (INSERT) ou eliminação (DELETE) de registos, ou que sejam alterados (UPDATE) os campos da geometria (geom) e &ldquo;codigo&rdquo;, o trigger executa uma única vez a função descrita acima:</p><pre><code>[code language=&quot;sql&quot;]
CREATE TRIGGER actualiza_paginas_update
AFTER INSERT OR UPDATE OF geom, codigo OR DELETE
ON epvu.sgev
FOR EACH STATEMENT
EXECUTE PROCEDURE epvu.refresh_geom_paginas_prestadores();
[/code]
</code></pre><p><strong>Nota</strong>: Depois de alguns teste, cheguei à conclusão que, dado o número reduzido de registos que tinha, era mais rápido usar uma VIEW. Continuo no entanto a achar que, este tipo de triggers podem ser úteis para pre-processar consultas mais exigentes. Para mais informação sobre o uso de triggers, a <a href=http://www.postgresql.org/docs/9.3/static/sql-createtrigger.html>documentação do PostgreSQL</a> é um excelente ponto de partida.</p></div><div class=btn-improve-page><a href=https://github.com/SrNetoChan/SrNetoChan.github.io/edit//content/posts/tutorials/2013-12-03-triggers-para-que-vos-quero.pt.markdown target=_blank><i class="fas fa-code-branch"></i>Improve this page</a></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/pt/posts/tutorials/2013-12-20-dissolver-poligonos-em-postgrespostgis/ class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i>Prev</div><div class=next-prev-text>Dissolver polígonos em Postgres\Postgis</div></a></div><div class="col-md-6 next-article"><a href=/pt/posts/tutorials/2013-05-29-substituir-strings-na-tabela-de-atributos-do-qgis/ class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>Substituir strings na tabela de atributos do QGIS</div></a></div></div><hr><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var dsq=document.createElement("script");dsq.type="text/javascript";dsq.async=true;var disqus_shortname="AlexandreNeto";dsq.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><span>Email:</span> <span>alex.f.neto@gmail.com</span></li><li><span>Phone:</span> <span>+0123456789</span></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2020 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script><script type=text/javascript src=/js/popper.min.js></script><script type=text/javascript src=/js/bootstrap.min.js></script><script type=text/javascript src=/js/navbar.js></script><script type=text/javascript src=/js/plyr.js></script><script type=text/javascript src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>