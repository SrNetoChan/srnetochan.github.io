<!doctype html><html lang=pt><head><title>Triggers para que vos quero...</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.dcac01d6ce454440e92fc94364314e8acdd7579fd3ec30c773e6b18a554ea62d.css integrity="sha256-3KwB1s5FREDpL8lDZDFOis3XV5/T7DDHc+axilVOpi0="><link rel=icon type=image/png href=/images/site/inverted-globe_hu1365588385401907432.png><meta property="og:url" content="https://srnetochan.github.io/pt/posts/tutorials/2013-12-03-triggers-para-que-vos-quero/"><meta property="og:site_name" content="Alexandre Neto"><meta property="og:title" content="Triggers para que vos quero..."><meta property="og:description" content="Há já algum tempo que queria estudar a funcionalidade de triggers em PostgreSQL. A grosso modo, tinha ideia que permitiam executar comandos de forma automática, sempre que se alterasse determinada tabela, mas desconhecia os mecanismos para o fazer. Uma das aplicações que me veio à ideia foi a de usar triggers para manter actualizado atributos geométricos como a área ou o comprimento. Quando editamos de elementos que contêm atributos relacionados com as dimensões, forma ou localização das suas geometrias (área, perímetro, comprimento), é muito fácil esquecermo-nos de os actualizar depois da edição. Se mais tarde usarmos esses atributos para realizar alguma análise, este esquecimento pode levar a resultados errados.Como exemplo, vou criar um trigger para actualizar os atributos “área”, “latitude” e “longitude” de uma tabela de polígonos.A primeira coisa a fazer é criar uma função que execute o que pretendemos. No caso em questão, usei a seguinte:"><meta property="og:locale" content="pt"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2013-12-03T23:09:47+00:00"><meta property="article:modified_time" content="2013-12-03T23:09:47+00:00"><meta property="article:tag" content="Postgis"><meta property="article:tag" content="Trigger"><meta name=twitter:card content="summary"><meta name=twitter:title content="Triggers para que vos quero..."><meta name=twitter:description content="Há já algum tempo que queria estudar a funcionalidade de triggers em PostgreSQL. A grosso modo, tinha ideia que permitiam executar comandos de forma automática, sempre que se alterasse determinada tabela, mas desconhecia os mecanismos para o fazer. Uma das aplicações que me veio à ideia foi a de usar triggers para manter actualizado atributos geométricos como a área ou o comprimento. Quando editamos de elementos que contêm atributos relacionados com as dimensões, forma ou localização das suas geometrias (área, perímetro, comprimento), é muito fácil esquecermo-nos de os actualizar depois da edição. Se mais tarde usarmos esses atributos para realizar alguma análise, este esquecimento pode levar a resultados errados.Como exemplo, vou criar um trigger para actualizar os atributos “área”, “latitude” e “longitude” de uma tabela de polígonos.A primeira coisa a fazer é criar uma função que execute o que pretendemos. No caso em questão, usei a seguinte:"><meta name=description content="Triggers para que vos quero..."><script async src="https://www.googletagmanager.com/gtag/js?id=G-CEJYGRYN1L"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CEJYGRYN1L")}</script><script src=https://cdn.counter.dev/script.js data-id=3f1214e8-aef3-401e-9ac7-f2faab83b345 data-utcoffset=1></script><script data-goatcounter=https://alexnetogeo.goatcounter.com/count async src=//gc.zgo.at/count.js></script><script>theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light",theme=="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/pt><img src=/images/site/globe_hu12549563965009133548.png id=logo alt=Logo>
Alexandre Neto</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/pt#home>Home</a></li><li class=nav-item><a class=nav-link href=/pt#about>Sobre</a></li><li class=nav-item><a class=nav-link href=/pt#skills>Serviços</a></li><li class=nav-item><a class=nav-link href=/pt#recent-posts>Artigos recentes</a></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/pt/posts>Posts</a></li><li class=nav-item><a class=nav-link href=/posts/plugins/>Plugins</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/globe_hu12549563965009133548.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/inverted-globe_hu1365588385401907432.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/pt/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/pt/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i data-feather=plus-circle></i><a class=list-link href=/pt/posts/opinion/> Artigos de Opinião</a><ul><li><a class=list-link href=/pt/posts/opinion/2013-03-26-nota-de-abertura/ title="Nota de abertura">Nota de abertura</a></li><li><a class=list-link href=/pt/posts/opinion/2013-03-31-porque-o-open-source/ title="Porquê o Open Source?">Porquê o Open Source?</a></li><li><a class=list-link href=/pt/posts/opinion/2013-04-04-as-queixas-do-costume/ title="As queixas do costume">As queixas do costume</a></li></ul></li><li><a class=list-link href=/pt/posts/news/ title=Notícias>Notícias</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/pt/posts/plugins/> Plugins</a><ul><li><a class=list-link href=/pt/posts/plugins/multipart-split/ title="Multipart Split">Multipart Split</a></li><li><a class=list-link href=/pt/posts/plugins/walking-time/ title="Walking time">Walking time</a></li></ul></li><li><a class="active list-link" href=/pt/posts/tutorials/ title=Tutoriais>Tutoriais</a></li><li><i data-feather=plus-circle></i><a class=list-link href> artigos-de-opiniao</a><ul><li><a class=list-link href=/pt/posts/opinion/2024-12-31-giovanni-had-an-itch/ title="Algo Inquietava o Giovanni...">Algo Inquietava o Giovanni...</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/aneto2_hu14961295241776032264.jpg alt="Author Image"><h5 class=author-name>Alexandre Neto</h5><p class=text-muted>terça-feira, 3 de dezembro de 2013 | 3 minutes</p></div><div class=title><h1>Triggers para que vos quero...</h1></div><div class=tags><ul style=padding-left:0><li class=rounded><a href=/pt/tags/postgis/ class="btn btn-sm btn-info">Postgis</a></li><li class=rounded><a href=/pt/tags/trigger/ class="btn btn-sm btn-info">trigger</a></li></ul></div><div class=post-content id=post-content><p>Há já algum tempo que queria estudar a funcionalidade de triggers em <a href=http://www.postgresql.org/ target=_blank rel=noopener>PostgreSQL</a>. A grosso modo, tinha ideia que permitiam executar comandos de forma automática, sempre que se alterasse determinada tabela, mas desconhecia os mecanismos para o fazer. Uma das aplicações que me veio à ideia foi a de usar triggers para manter actualizado atributos geométricos como a área ou o comprimento. Quando editamos de elementos que contêm atributos relacionados com as dimensões, forma ou localização das suas geometrias (área, perímetro, comprimento), é muito fácil esquecermo-nos de os actualizar depois da edição. Se mais tarde usarmos esses atributos para realizar alguma análise, este esquecimento pode levar a resultados errados.Como exemplo, vou criar um trigger para actualizar os atributos &ldquo;área&rdquo;, &ldquo;latitude&rdquo; e &ldquo;longitude&rdquo; de uma tabela de polígonos.A primeira coisa a fazer é criar uma função que execute o que pretendemos. No caso em questão, usei a seguinte:</p><pre><code>CREATE OR REPLACE FUNCTION update_geometry_fields()
RETURNS trigger;
$BODY$
DECLARE
lat_long TEXT;
BEGIN
-- Cálculo da área da geometria
NEW.area = st_area(NEW.geom);

-- Cálculo da latitude e longitude do centroíde da geometria em graus minutos e segundos
lat_long := ST_AsLatLonText(st_transform(st_centroid(NEW.geom), 4326));
NEW.latitude = split_part(lat_long,' ',1);
NEW.longitude = split_part(lat_long,' ',2);

RETURN NEW;
END;
$BODY$
LANGUAGE plpgsql VOLATILE
</code></pre><p>Depois, é necessário criar o trigger que despolete a função:</p><pre><code>CREATE TRIGGER update_epvu_sgev_geom_fields
BEFORE INSERT OR UPDATE OF geom
ON epvu.sgev
FOR EACH ROW
EXECUTE PROCEDURE update_geometry_fields();
</code></pre><p>O trigger, quando lido em inglês, é bastante simples de entender. Antes de inserir uma linha nova, ou actualizar a geometria (geom) de uma linha existente da tabela &ldquo;epvu.sgev&rdquo;, executa a função update_geometry_fields() De notar que a criação do triggers (e respectivas funções) pode ter variações. Em primeiro lugar, os triggers podem ser despoletados antes ou depois de um INSERT, DELETE ou UPDATE numa tabela. Em segundo, podem executar a função sobre toda a tabela ou apenas nas linhas em questão. Para ilustrar estas diferenças, mais um exemplo. Com o objectivo de optimizar a impressão em mapas no <a href=www.qgis.org>QGIS</a>, através da nova funcionalidade de <a href=http://docs.qgis.org/testing/en/docs/user_manual/print_composer/print_composer.html#atlas-generation target=_blank rel=noopener>atlas</a> do print composer, criei uma consulta para agregar vários polígonos com base num atributo (&ldquo;codigo&rdquo;) e me determinasse se os multi-polígonos resultantes encaixava melhor numa folha ao alto ou deitado. Na tentativa de tornar o processo mais rápido, pensei em gravar a consulta como tabela mantê-la actualizada sempre que alguma alteração pertinente ocorresse através de um trigger. A função a usar no trigger era pouco mais que a consulta em si:</p><pre><code>CREATE OR REPLACE FUNCTION epvu.refresh_geom_paginas_prestadores()
RETURNS trigger AS
$BODY$
BEGIN
TRUNCATE epvu.geom_paginas_prestadores restart identity;
INSERT INTO epvu.geom_paginas_prestadores (codigo, formato, geom)
(WITH g as
(SELECT (st_union(st_makevalid(geom))) AS geom,
    codigo
 FROM
    epvu.sgev
 GROUP BY codigo
)
SELECT
    g.codigo,
    CASE WHEN abs(ST_XMax(g.geom)-ST_XMin(g.geom)) &gt; abs(ST_YMax(g.geom)-ST_YMin(g.geom)) THEN
        'Landscape'
    ELSE
        'Portrait'
    END as formato,
    st_multi(g.geom) as geom
FROM g);
RETURN NEW;
END;
$BODY$
LANGUAGE plpgsql VOLATILE
</code></pre><p>Neste caso, a função deve ser despoletada sempre que forem feitas alterações à tabela que usada na consulta (epvu.sgev) e que possam alterar os seus resultados. Assim, sempre que haja introdução (INSERT) ou eliminação (DELETE) de registos, ou que sejam alterados (UPDATE) os campos da geometria (geom) e &ldquo;codigo&rdquo;, o trigger executa uma única vez a função descrita acima:</p><pre><code>CREATE TRIGGER actualiza_paginas_update
AFTER INSERT OR UPDATE OF geom, codigo OR DELETE
ON epvu.sgev
FOR EACH STATEMENT
</code></pre><p><strong>Nota</strong>: Depois de alguns teste, cheguei à conclusão que, dado o número reduzido de registos que tinha, era mais rápido usar uma VIEW. Continuo no entanto a achar que, este tipo de triggers podem ser úteis para pre-processar consultas mais exigentes. Para mais informação sobre o uso de triggers, a <a href=http://www.postgresql.org/docs/9.3/static/sql-createtrigger.html target=_blank rel=noopener>documentação do PostgreSQL</a> é um excelente ponto de partida.</p></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fsrnetochan.github.io%2fpt%2fposts%2ftutorials%2f2013-12-03-triggers-para-que-vos-quero%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fsrnetochan.github.io%2fpt%2fposts%2ftutorials%2f2013-12-03-triggers-para-que-vos-quero%2f&text=Triggers%20para%20que%20vos%20quero...&via=Alexandre%20Neto" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsrnetochan.github.io%2fpt%2fposts%2ftutorials%2f2013-12-03-triggers-para-que-vos-quero%2f&title=Triggers%20para%20que%20vos%20quero..." target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fsrnetochan.github.io%2fpt%2fposts%2ftutorials%2f2013-12-03-triggers-para-que-vos-quero%2f&title=Triggers%20para%20que%20vos%20quero..." target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button bg-mastodon" href="https://mastodon.social/share?text=Triggers%20para%20que%20vos%20quero... - https%3a%2f%2fsrnetochan.github.io%2fpt%2fposts%2ftutorials%2f2013-12-03-triggers-para-que-vos-quero%2f" target=_blank><i class="fab fa-mastodon"></i>
</a><a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=Triggers%20para%20que%20vos%20quero... https%3a%2f%2fsrnetochan.github.io%2fpt%2fposts%2ftutorials%2f2013-12-03-triggers-para-que-vos-quero%2f" target=_blank><i class="fab fa-whatsapp"></i>
</a><a class="btn icon-button" href="mailto:?subject=Triggers%20para%20que%20vos%20quero...&body=https%3a%2f%2fsrnetochan.github.io%2fpt%2fposts%2ftutorials%2f2013-12-03-triggers-para-que-vos-quero%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/SrNetoChan/SrNetoChan.github.io/edit/site_source/content/posts/tutorials/2013-12-03-triggers-para-que-vos-quero.pt.markdown title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"></div><hr></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://srnetochan.github.io/pt/#about>Sobre</a></li><li class=nav-item><a class=smooth-scroll href=https://srnetochan.github.io/pt/#skills>Serviços</a></li><li class=nav-item><a class=smooth-scroll href=https://srnetochan.github.io/pt/#recent-posts>Artigos recentes</a></li><li class=nav-item><a class=smooth-scroll href=/posts/plugins/>Plugins</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=https://github.com/srnetochan target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>srnetochan</span></a></li><li><a href=https://www.linkedin.com/in/alexandre-neto-geo target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>Alexandre Neto</span></a></li><li><a href=https://t.me/alexnetogeo target=_blank rel=noopener><span><i class="fab fa-telegram"></i></span> <span>@alexnetogeo</span></a></li><li><a href=https://twitter.com/AlexNetoGeo target=_blank rel=noopener><span><i class="fab fa-twitter"></i></span> <span>@alexnetogeo</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu16779671404603505019.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2022 Copyright. <a href=https://www.flaticon.com/free-icons/internet title="internet icons">Globe icon created by Freepik - Flaticon</a></div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.e6988f7e96686bcbaa8fb212d287df00acbd3ec7a5e10bfb2eb4167016d389c7.js integrity="sha256-5piPfpZoa8uqj7IS0offAKy9Psel4Qv7LrQWcBbTicc=" defer></script><script src=https://storage.ko-fi.com/cdn/scripts/overlay-widget.js></script><script>kofiWidgetOverlay.draw("alexandreneto",{type:"floating-chat","floating-chat.donateButton.text":"Tip Me","floating-chat.donateButton.text-color":"#f9fafc","floating-chat.donateButton.background-color":"#248aaa"})</script></body></html>